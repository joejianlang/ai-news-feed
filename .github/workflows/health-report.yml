name: Daily Health Report

on:
  schedule:
    # æ¯å¤©æ—©ä¸Š 8:00 (ä¸œéƒ¨æ—¶é—´) è¿è¡Œ = UTC 13:00
    - cron: '0 13 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  health-check:
    runs-on: ubuntu-latest
    permissions:
      issues: write  # éœ€è¦æƒé™æ¥åˆ›å»º Issue
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Run Health Check
        id: health_check
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: npx tsx ./scripts/daily_health_report.ts

      - name: Create Issue if Problems Found
        if: steps.health_check.outputs.has_problems == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const today = new Date().toISOString().split('T')[0];
            const title = `âš ï¸ æ–°é—»æºå¥åº·é—®é¢˜ - ${today}`;
            
            // æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²ç»æœ‰ issue
            const { data: existingIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'health-report',
              per_page: 10
            });
            
            const todayIssue = existingIssues.find(i => i.title.includes(today));
            
            if (todayIssue) {
              console.log('ä»Šå¤©çš„ Issue å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º');
              return;
            }
            
            // åˆ›å»ºæ–° Issue
            const problemCount = '${{ steps.health_check.outputs.problem_count }}';
            const body = `
            ## ğŸ”” æ¯æ—¥å¥åº·æ£€æŸ¥å‘ç°é—®é¢˜
            
            å‘ç° **${problemCount}** ä¸ªæ–°é—»æºéœ€è¦å…³æ³¨ã€‚
            
            ### æŸ¥çœ‹è¯¦æƒ…
            
            è¯·æŸ¥çœ‹ [ä»Šæ—¥ GitHub Actions æ—¥å¿—](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${{ github.run_id }}) è·å–å®Œæ•´æŠ¥å‘Šã€‚
            
            ### å¸¸è§å¤„ç†æ–¹å¼
            
            1. **æ£€æŸ¥ URL æœ‰æ•ˆæ€§** - å¯èƒ½æºç½‘ç«™å·²æ›´æ”¹æˆ–ä¸‹çº¿
            2. **æŸ¥çœ‹é”™è¯¯æ—¥å¿—** - åœ¨ Actions æ—¥å¿—ä¸­æŸ¥æ‰¾å…·ä½“é”™è¯¯
            3. **ç¦ç”¨é—®é¢˜æº** - åœ¨ Supabase çš„ \`news_sources\` è¡¨ä¸­å°† \`is_active\` è®¾ä¸º \`false\`
            
            ---
            *æ­¤ Issue ç”±è‡ªåŠ¨å¥åº·æ£€æŸ¥ç³»ç»Ÿç”Ÿæˆ*
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['health-report', 'automated']
            });
            
            console.log('å·²åˆ›å»ºå¥åº·æŠ¥å‘Š Issue');

      - name: Log Success (No Problems)
        if: steps.health_check.outputs.has_problems != 'true'
        run: echo "âœ… æ‰€æœ‰æ–°é—»æºè¿è¡Œæ­£å¸¸ï¼Œæ— éœ€åˆ›å»º Issue"
